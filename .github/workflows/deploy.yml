name: CI/CD Pipeline for Stock Lab

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ap-northeast-2
  ECR_BACKEND_REPO: stocklab-backend
  ECR_FRONTEND_REPO: stocklab-frontend

jobs:
  # Job 1: 테스트
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('SL-Back-end/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Backend dependencies
        run: |
          cd SL-Back-end
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Backend linter
        run: |
          cd SL-Back-end
          pip install flake8
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Linting completed with warnings"

      - name: Run Backend tests
        run: |
          cd SL-Back-end
          pip install pytest pytest-asyncio
          pytest tests/ -v || echo "Tests completed"
        continue-on-error: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: SL-Front-End/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('SL-Front-End/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Frontend dependencies
        run: |
          cd SL-Front-End
          npm ci

      - name: Run Frontend linter
        run: |
          cd SL-Front-End
          npm run lint || echo "Linting completed"
        continue-on-error: true

  # Job 2: 빌드 및 ECR에 푸시
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    outputs:
      backend-image: ${{ steps.build-backend.outputs.image }}
      frontend-image: ${{ steps.build-frontend.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Backend image
        id: build-backend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd SL-Back-end

          # Docker 이미지 빌드
          docker build -t $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG $ECR_REGISTRY/$ECR_BACKEND_REPO:latest

          # ECR에 푸시
          docker push $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_BACKEND_REPO:latest

          # Output 설정
          echo "image=$ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Build and push Frontend image
        id: build-frontend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd SL-Front-End

          # Docker 이미지 빌드
          docker build \
            --build-arg NEXT_PUBLIC_API_BASE_URL=${{ secrets.ALB_DNS_URL }}/api/v1 \
            -t $ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG $ECR_REGISTRY/$ECR_FRONTEND_REPO:latest

          # ECR에 푸시
          docker push $ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_FRONTEND_REPO:latest

          # Output 설정
          echo "image=$ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG" >> $GITHUB_OUTPUT

  # Job 3: Auto Scaling Group 배포
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Trigger Auto Scaling Group Instance Refresh
        run: |
          echo "Starting Instance Refresh for Auto Scaling Group..."

          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ secrets.ASG_NAME }} \
            --preferences '{
              "MinHealthyPercentage": 50,
              "InstanceWarmup": 300,
              "CheckpointPercentages": [50, 100],
              "CheckpointDelay": 300
            }' \
            --desired-configuration '{
              "LaunchTemplate": {
                "LaunchTemplateName": "${{ secrets.LAUNCH_TEMPLATE_NAME }}",
                "Version": "$Latest"
              }
            }'

          echo "Instance Refresh started successfully"

      - name: Wait for deployment to complete
        run: |
          echo "Waiting for Instance Refresh to complete..."

          # Instance Refresh 완료 대기 (최대 30분)
          for i in {1..60}; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name ${{ secrets.ASG_NAME }} \
              --query 'InstanceRefreshes[0].Status' \
              --output text)

            echo "Current status: $STATUS (Check $i/60)"

            if [ "$STATUS" = "Successful" ]; then
              echo "✅ Deployment completed successfully!"
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ]; then
              echo "❌ Deployment failed with status: $STATUS"
              exit 1
            fi

            sleep 30
          done

          echo "⚠️ Deployment timeout after 30 minutes"
          exit 1

      - name: Verify deployment
        if: success()
        run: |
          echo "Verifying deployment..."

          # Target Group의 Healthy 인스턴스 수 확인
          HEALTHY_COUNT=$(aws elbv2 describe-target-health \
            --target-group-arn ${{ secrets.TARGET_GROUP_ARN }} \
            --query 'length(TargetHealthDescriptions[?TargetHealth.State==`healthy`])' \
            --output text)

          echo "Healthy instances: $HEALTHY_COUNT"

          if [ "$HEALTHY_COUNT" -ge 2 ]; then
            echo "✅ Deployment verified: $HEALTHY_COUNT healthy instances"
          else
            echo "⚠️ Warning: Only $HEALTHY_COUNT healthy instances"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "========================================="
          echo "Deployment Summary"
          echo "========================================="
          echo "Backend Image: ${{ needs.build-and-push.outputs.backend-image }}"
          echo "Frontend Image: ${{ needs.build-and-push.outputs.frontend-image }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "========================================="
