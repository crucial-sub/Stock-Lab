name: Staging Deployment Pipeline

on:
  push:
    branches: [staging]
  pull_request:
    branches: [staging]

env:
  AWS_REGION: ap-northeast-2
  ECR_BACKEND_REPO: stocklab-backend-staging
  ECR_FRONTEND_REPO: stocklab-frontend-staging
  ENVIRONMENT: staging

jobs:
  # Job 1: 코드 품질 및 보안 검사
  quality-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('SL-Back-end/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Backend dependencies
        run: |
          cd SL-Back-end
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest pytest-asyncio pytest-cov

      - name: Run Backend linter
        run: |
          cd SL-Back-end
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run Backend tests with coverage
        run: |
          cd SL-Back-end
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=term
        continue-on-error: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: SL-Front-End/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('SL-Front-End/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Frontend dependencies
        run: |
          cd SL-Front-End
          corepack enable
          corepack prepare pnpm@latest --activate
          pnpm install --frozen-lockfile

      - name: Run Frontend linter
        run: |
          cd SL-Front-End
          pnpm run lint

      - name: Run Frontend type check
        run: |
          cd SL-Front-End
          pnpm run build
        continue-on-error: false

  # Job 2: 보안 스캔
  security-scan:
    runs-on: ubuntu-latest
    needs: quality-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner - Backend
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './SL-Back-end'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-backend-results.sarif'
          category: 'backend-security'

      - name: Run Trivy vulnerability scanner - Frontend
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './SL-Front-End'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'frontend-security'

  # Job 3: Docker 이미지 빌드 및 스캔
  build-and-scan:
    needs: [quality-checks, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'

    outputs:
      backend-image: ${{ steps.build-backend.outputs.image }}
      frontend-image: ${{ steps.build-frontend.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Backend image
        id: build-backend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd SL-Back-end
          docker build -t $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG $ECR_REGISTRY/$ECR_BACKEND_REPO:latest
          echo "image=$ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Scan Backend Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.build-backend.outputs.image }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Push Backend image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_BACKEND_REPO:latest

      - name: Build Frontend image
        id: build-frontend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd SL-Front-End
          docker build \
            --build-arg NEXT_PUBLIC_API_BASE_URL=${{ secrets.STAGING_ALB_DNS_URL }}/api/v1 \
            -t $ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG $ECR_REGISTRY/$ECR_FRONTEND_REPO:latest
          echo "image=$ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Scan Frontend Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.build-frontend.outputs.image }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Push Frontend image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_FRONTEND_REPO:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_FRONTEND_REPO:latest

  # Job 4: Staging 배포
  deploy-staging:
    needs: build-and-scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Store current ASG desired capacity (for rollback)
        id: store-asg-state
        run: |
          CURRENT_CAPACITY=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names ${{ secrets.STAGING_ASG_NAME }} \
            --query 'AutoScalingGroups[0].DesiredCapacity' \
            --output text)
          echo "current_capacity=$CURRENT_CAPACITY" >> $GITHUB_OUTPUT
          echo "Current ASG capacity: $CURRENT_CAPACITY"

      - name: Trigger Auto Scaling Group Instance Refresh
        id: instance-refresh
        run: |
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ secrets.STAGING_ASG_NAME }} \
            --preferences '{
              "MinHealthyPercentage": 50,
              "InstanceWarmup": 300,
              "CheckpointPercentages": [50, 100],
              "CheckpointDelay": 180
            }' \
            --desired-configuration '{
              "LaunchTemplate": {
                "LaunchTemplateName": "${{ secrets.STAGING_LAUNCH_TEMPLATE_NAME }}",
                "Version": "$Latest"
              }
            }' \
            --query 'InstanceRefreshId' \
            --output text)

          echo "refresh_id=$REFRESH_ID" >> $GITHUB_OUTPUT
          echo "Instance Refresh ID: $REFRESH_ID"

      - name: Wait for deployment to complete
        id: wait-deployment
        run: |
          REFRESH_ID="${{ steps.instance-refresh.outputs.refresh_id }}"

          for i in {1..40}; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name ${{ secrets.STAGING_ASG_NAME }} \
              --instance-refresh-ids $REFRESH_ID \
              --query 'InstanceRefreshes[0].Status' \
              --output text)

            echo "[$i/40] Current status: $STATUS"

            if [ "$STATUS" = "Successful" ]; then
              echo "deployment_status=success" >> $GITHUB_OUTPUT
              echo "Deployment completed successfully!"
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ]; then
              echo "deployment_status=failed" >> $GITHUB_OUTPUT
              echo "Deployment failed with status: $STATUS"
              exit 1
            fi

            sleep 30
          done

          echo "deployment_status=timeout" >> $GITHUB_OUTPUT
          echo "Deployment timeout after 20 minutes"
          exit 1

      - name: Verify deployment
        if: steps.wait-deployment.outputs.deployment_status == 'success'
        run: |
          HEALTHY_COUNT=$(aws elbv2 describe-target-health \
            --target-group-arn ${{ secrets.STAGING_TARGET_GROUP_ARN }} \
            --query 'length(TargetHealthDescriptions[?TargetHealth.State==`healthy`])' \
            --output text)

          echo "Healthy instances in target group: $HEALTHY_COUNT"

          if [ "$HEALTHY_COUNT" -ge 1 ]; then
            echo "Deployment verified: $HEALTHY_COUNT healthy instances"
          else
            echo "Warning: Only $HEALTHY_COUNT healthy instances"
            exit 1
          fi

      - name: Rollback on failure
        if: failure() && steps.instance-refresh.outputs.refresh_id != ''
        run: |
          echo "Deployment failed. Initiating rollback..."

          # Cancel current instance refresh
          aws autoscaling cancel-instance-refresh \
            --auto-scaling-group-name ${{ secrets.STAGING_ASG_NAME }} || true

          # Rollback to previous version by starting new refresh with older launch template version
          echo "Rolling back to previous launch template version..."

          # Get previous version
          PREVIOUS_VERSION=$(aws ec2 describe-launch-template-versions \
            --launch-template-name ${{ secrets.STAGING_LAUNCH_TEMPLATE_NAME }} \
            --query 'LaunchTemplateVersions[1].VersionNumber' \
            --output text)

          if [ "$PREVIOUS_VERSION" != "None" ]; then
            aws autoscaling start-instance-refresh \
              --auto-scaling-group-name ${{ secrets.STAGING_ASG_NAME }} \
              --desired-configuration "{
                \"LaunchTemplate\": {
                  \"LaunchTemplateName\": \"${{ secrets.STAGING_LAUNCH_TEMPLATE_NAME }}\",
                  \"Version\": \"$PREVIOUS_VERSION\"
                }
              }"
            echo "Rollback initiated to version $PREVIOUS_VERSION"
          fi

  # Job 5: Slack 알림
  notify:
    needs: [build-and-scan, deploy-staging]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/staging' && github.event_name == 'push'

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "Staging Deployment ${{ needs.deploy-staging.result == 'success' && 'Successful' || 'Failed' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ needs.deploy-staging.result == 'success' && '✅' || '❌' }} Staging Deployment ${{ needs.deploy-staging.result == 'success' && 'Successful' || 'Failed' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nStaging"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ needs.deploy-staging.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n<${{ github.event.head_commit.url }}|${{ github.sha }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Message:* ${{ github.event.head_commit.message }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
