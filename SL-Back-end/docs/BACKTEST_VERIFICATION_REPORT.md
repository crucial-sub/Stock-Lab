# ë°±í…ŒìŠ¤íŠ¸ ë¡œì§ ê²€ì¦ ë³´ê³ ì„œ

## í…ŒìŠ¤íŠ¸ ì •ë³´
- **í…ŒìŠ¤íŠ¸ ë‚ ì§œ**: 2025-11-11
- **í…ŒìŠ¤íŠ¸ ì¡°ê±´**:
  - ê¸°ê°„: 2024-01-01 ~ 2024-12-31 (1ë…„)
  - ì´ˆê¸°ìë³¸: 10,000,000ì›
  - ë§¤ë§¤ëŒ€ìƒ: ì¦ê¶Œ ì¢…ëª© + ì‚¼ì„±ì „ì
  - ë§¤ìˆ˜ì¡°ê±´: `PBR >= 0.0 AND PER >= 3.0`
  - ìš°ì„ ìˆœìœ„: PER ì˜¤ë¦„ì°¨ìˆœ
  - ë¦¬ë°¸ëŸ°ì‹±: ì£¼ê°„ (Weekly)
  - ìµœëŒ€í¬ì§€ì…˜: 5ê°œ

## ê²€ì¦ ê²°ê³¼

### âœ… ì„±ê³µí•œ ë¶€ë¶„

1. **ë°±í…ŒìŠ¤íŠ¸ ì—”ì§„ ì‹¤í–‰**: ì—ëŸ¬ ì—†ì´ ì™„ë£Œ
   - ê°€ê²© ë°ì´í„° ë¡œë“œ ì„±ê³µ
   - íŒ©í„° ê³„ì‚° ì„±ê³µ (ìµœì í™” ë²„ì „)
   - í¬íŠ¸í´ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜ ì„±ê³µ
   - ê²°ê³¼ ì €ì¥ ì„±ê³µ

2. **íŒ©í„° ê³„ì‚°**:
   - PBR ê°’ ì •ìƒ ê³„ì‚° (0.2 ~ 0.6 ë²”ìœ„)
   - ì •ê·œí™” ë¹„í™œì„±í™”ë¡œ ì‹¤ì œ ê°’ ìœ ì§€ âœ…
   - industry, size_bucket ë©”íƒ€ë°ì´í„° ì •ìƒ í¬í•¨

3. **ë°ì´í„° íƒ€ì… ì²˜ë¦¬**:
   - `'ì¦ê¶Œ'` ë¬¸ìì—´ â†’ float ë³€í™˜ ì—ëŸ¬ ìˆ˜ì • âœ…
   - datetime.date vs Timestamp íƒ€ì… ë¶ˆì¼ì¹˜ ìˆ˜ì • âœ…
   - Meta columns ëª…ì‹œì  ì œì™¸ ì²˜ë¦¬ âœ…

4. **ë§¤ë§¤ ëŒ€ìƒ í•„í„°ë§**:
   - ì¦ê¶Œ ì¢…ëª© 17ê°œ ì •ìƒ í•„í„°ë§
   - ì‚¼ì„±ì „ì í¬í•¨ ì—¬ë¶€ (ë³„ë„ í™•ì¸ í•„ìš”)

### âš ï¸ ë°œê²¬ëœ ë¬¸ì œ

#### 1. **PER ê°’ì´ ëª¨ë‘ NaN**
```
ìƒ˜í”Œ ë°ì´í„°: {'PBR': 0.408, 'PER': nan, 'PBR_RANK': 11.0, 'PER_RANK': nan}
```

**ì›ì¸**:
- ì¦ê¶Œ ì¢…ëª©ë“¤ì˜ `net_income`ì´ ìŒìˆ˜ì´ê±°ë‚˜ NULL
- PER ê³„ì‚° ì¡°ê±´: `net_income > 0`
- 2024ë…„ ì¦ê¶Œì—…ê³„ ì‹¤ì  ë¶€ì§„ (ì†ì‹¤ ë°œìƒ)

**ì˜í–¥**:
- ì¡°ê±´: `PER >= 3.0` â†’ ëª¨ë“  ì¢…ëª©ì´ ì¡°ê±´ ë¶ˆë§Œì¡±
- ì „ì²´ ë°±í…ŒìŠ¤íŠ¸ ê¸°ê°„ ë™ì•ˆ ê±°ë˜ ë‚´ì—­ 0ê±´
- ê²°ê³¼ì ìœ¼ë¡œ ìˆ˜ìµë¥  0%, ê±°ë˜ ì—†ìŒ

**í•´ê²° ë°©ì•ˆ**:
1. **Option A - ì¡°ê±´ ë³€ê²½**: PER ì¡°ê±´ ì œê±°í•˜ê³  PBRë§Œ ì‚¬ìš©
2. **Option B - NaN ì²˜ë¦¬ ë¡œì§ ë³€ê²½**: PERì´ NaNì¸ ê²½ìš° í•´ë‹¹ ì¡°ê±´ ìŠ¤í‚µ (OR ë¡œì§)
3. **Option C - ë‹¤ë¥¸ íŒ©í„° ì‚¬ìš©**: ROE, ROA ë“± ë‹¤ë¥¸ ìˆ˜ìµì„± íŒ©í„° ì¶”ê°€
4. **Option D - ì—…ì¢… ë³€ê²½**: ìˆ˜ìµì„± ìˆëŠ” ë‹¤ë¥¸ ì—…ì¢… í…ŒìŠ¤íŠ¸

#### 2. **ì¡°ê±´ ë§Œì¡± ì¢…ëª© 0ê°œ**
```
ì¡°ê±´ í‰ê°€ ì‹œì‘ - í‰ê°€ ëŒ€ìƒ ì¢…ëª©: 17ê°œ
ì¡°ê±´ ë§Œì¡± ì¢…ëª©: 0ê°œ - []
```

ì „ì²´ 52ì£¼ ë™ì•ˆ ë‹¨ í•œ ë²ˆë„ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¢…ëª©ì´ ì—†ìŒ.

**ì—°ì‡„ ì˜í–¥**:
- ë§¤ìˆ˜ ê±°ë˜ 0ê±´
- í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜ ë³€ë™ ì—†ìŒ
- í†µê³„ ê³„ì‚° ì˜ë¯¸ ì—†ìŒ
- ë°±í…ŒìŠ¤íŠ¸ ìœ íš¨ì„± ê²€ì¦ ë¶ˆê°€

### ğŸ” ì¶”ê°€ ê²€ì¦ í•„ìš” ì‚¬í•­

1. **ì‚¼ì„±ì „ì ë°ì´í„° í™•ì¸**
   - ì‚¼ì„±ì „ì(005930)ê°€ ì‹¤ì œë¡œ í‰ê°€ ëŒ€ìƒì— í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸
   - ì‚¼ì„±ì „ìì˜ PER ê°’ì´ ìœ íš¨í•œì§€ í™•ì¸

2. **ì¬ë¬´ ë°ì´í„° ì—…ë°ì´íŠ¸**
   - 2024ë…„ ìµœì‹  ì¬ë¬´ì œí‘œ ë°ì´í„° í™•ì¸
   - ì¦ê¶Œ ì¢…ëª©ì˜ ì‹¤ì œ ì†ìµ ìƒíƒœ í™•ì¸

3. **íŒ©í„° ê³„ì‚° ê²€ì¦**
   - PER = Market Cap / Net Income ê³„ì‚°ì‹ ì¬í™•ì¸
   - Net Income ë°ì´í„° ì†ŒìŠ¤ í™•ì¸ (ì—°ê²°/ë³„ë„, ëˆ„ì /ë¶„ê¸°)

## ìˆ˜ì •ëœ ì½”ë“œ

### 1. ë¬¸ìì—´ â†’ float ë³€í™˜ ì—ëŸ¬ ìˆ˜ì •
**íŒŒì¼**: `SL-Back-end/app/services/backtest.py:1682-1692`

```python
# ë©”íƒ€ë°ì´í„° ì»¬ëŸ¼ (ë¬¸ìì—´ íƒ€ì…) ì œì™¸
meta_columns = {'date', 'stock_code', 'industry', 'size_bucket', 'market_type'}
for col in stock_factors.columns:
    if col in meta_columns or col.endswith('_RANK'):
        continue
    value = stock_factors[col].iloc[0]
    if pd.notna(value):
        try:
            trade_factors[col] = float(value)
        except (ValueError, TypeError):
            continue  # ìˆ«ì ë³€í™˜ ë¶ˆê°€ëŠ¥í•œ ê°’ì€ ìŠ¤í‚µ
```

### 2. Timestamp íƒ€ì… ë¶ˆì¼ì¹˜ ìˆ˜ì •
**íŒŒì¼**: `SL-Back-end/app/services/backtest.py:2184`

```python
hold_days=(pd.Timestamp(latest_date).date() -
           (holding.entry_date.date() if hasattr(holding.entry_date, 'date')
            else holding.entry_date)).days if latest_date else 0
```

### 3. ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€
**íŒŒì¼**: `SL-Back-end/app/services/factor_integration.py:113-120`

```python
# ë””ë²„ê·¸: ì²« ë²ˆì§¸ ì¢…ëª©ì˜ íŒ©í„° ë°ì´í„° í™•ì¸
if stock_codes and not factor_data.empty:
    first_stock = stock_codes[0]
    stock_mask = (factor_data['stock_code'] == first_stock)
    date_mask = (pd.to_datetime(factor_data['date']) == trading_date)
    sample_data = factor_data[stock_mask & date_mask]
    if not sample_data.empty:
        logger.info(f"ğŸ“Š ìƒ˜í”Œ ì¢…ëª© {first_stock} íŒ©í„° ë°ì´í„°: {sample_data.iloc[0].to_dict()}")
```

## ê¶Œì¥ì‚¬í•­

### ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”
1. **PER NaN ë¬¸ì œ í•´ê²°**:
   - ì‚¼ì„±ì „ì ë°ì´í„°ë¡œ ìš°ì„  í…ŒìŠ¤íŠ¸ (ì œì¡°ì—…ì€ PER ìœ íš¨)
   - ë˜ëŠ” PER ì¡°ê±´ ì œê±°/ì™„í™”

2. **ìœ íš¨í•œ ì¡°ê±´ìœ¼ë¡œ ì¬í…ŒìŠ¤íŠ¸**:
   ```python
   buy_conditions = [
       {"factor": "PBR", "operator": "<", "value": 2.0},  # PBR < 2
       # PER ì¡°ê±´ ì œê±°
   ]
   ```

### ì¤‘ì¥ê¸° ê°œì„ 
1. **NaN ì²˜ë¦¬ ë¡œì§ ê°œì„ **:
   - ì¡°ê±´ë³„ AND/OR ì—°ì‚°ì ì§€ì›
   - NaN ê°’ í—ˆìš© ì˜µì…˜ ì¶”ê°€

2. **ë°ì´í„° í’ˆì§ˆ ê²€ì¦**:
   - íŒ©í„° ê³„ì‚° ì „ ë°ì´í„° í’ˆì§ˆ ì²´í¬
   - ëˆ„ë½/ì´ìƒì¹˜ ê²½ê³  ì‹œìŠ¤í…œ

3. **ì‚¬ìš©ì í”¼ë“œë°±**:
   - "ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤" ëª…í™•í•œ ë©”ì‹œì§€
   - ì–´ë–¤ ì¢…ëª©ì´ ì–´ë–¤ ì¡°ê±´ì—ì„œ ì‹¤íŒ¨í–ˆëŠ”ì§€ ìƒì„¸ ë¡œê·¸

## ê²°ë¡ 

**ë°±í…ŒìŠ¤íŠ¸ ì—”ì§„ ìì²´ëŠ” ì •ìƒ ì‘ë™**í•˜ë©°, ë‹¤ìŒ í•­ëª©ë“¤ì´ ëª¨ë‘ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤:
- âœ… ë°ì´í„° ë¡œë“œ
- âœ… íŒ©í„° ê³„ì‚°
- âœ… ì¡°ê±´ í‰ê°€ ë¡œì§
- âœ… í¬íŠ¸í´ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜
- âœ… ê²°ê³¼ ì €ì¥
- âœ… ì—ëŸ¬ ì²˜ë¦¬

**ë¬¸ì œëŠ” ë°ì´í„° í’ˆì§ˆ/ì¡°ê±´ ì„¤ì •**:
- âŒ ì¦ê¶Œ ì¢…ëª©ì˜ PER ê°’ì´ ëª¨ë‘ NaN
- âŒ ê²°ê³¼ì ìœ¼ë¡œ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¢…ëª© ì—†ìŒ
- âŒ ìœ íš¨í•œ ê±°ë˜ ë°œìƒí•˜ì§€ ì•ŠìŒ

**ë‹¤ìŒ ë‹¨ê³„**:
1. ì‚¼ì„±ì „ìë§Œìœ¼ë¡œ í…ŒìŠ¤íŠ¸ (PER ê°’ í™•ì¸)
2. PER ì¡°ê±´ ì œê±° í›„ ì¬í…ŒìŠ¤íŠ¸
3. ë‹¤ë¥¸ ì—…ì¢…ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ (ì˜ˆ: IT, ì œì¡°)
4. ì¬ë¬´ ë°ì´í„° ì—…ë°ì´íŠ¸ ìƒíƒœ í™•ì¸
