import { Title, UnderlineInput } from "@/components/common";
import { FactorSelectionModal } from "@/components/quant/FactorSelectionModal";
import {
  ConditionCard,
  FieldPanel,
  SectionHeader,
} from "@/components/quant/ui";
import { useFactorsQuery } from "@/hooks/useFactorsQuery";
import { useSubFactorsQuery } from "@/hooks/useSubFactorsQuery";
import { useBacktestConfigStore } from "@/stores";
import Image from "next/image";
import { useEffect, useState, useRef } from "react";
import { useShallow } from "zustand/react/shallow";

/**
 * ë§¤ìˆ˜ ì¡°ê±´ì‹ ì„¤ì • ì„¹ì…˜
 * - ì¡°ê±´ì‹ ëª©ë¡ ê´€ë¦¬
 * - ë…¼ë¦¬ ì¡°ê±´ì‹ ì‘ì„±
 * - ë§¤ìˆ˜ ì¢…ëª© ì„ íƒ ìš°ì„ ìˆœìœ„ (íŒ©í„° ì„ íƒ ëª¨ë‹¬ ì‚¬ìš©)
 */
export function BuyConditionsSection() {
  // âœ… useShallow hook ì‚¬ìš© (ë°ì´í„°ì™€ í•¨ìˆ˜ ë¶„ë¦¬)
  const { buyConditionsUI, buy_logic, priority_factor, priority_order } =
    useBacktestConfigStore(
      useShallow((state) => ({
        buyConditionsUI: state.buyConditionsUI,
        buy_logic: state.buy_logic,
        priority_factor: state.priority_factor,
        priority_order: state.priority_order,
      })),
    );

  // í•¨ìˆ˜ë“¤ì€ ë³„ë„ë¡œ ì„ íƒ (ì•ˆì •ì ì¸ ì°¸ì¡°)
  const addBuyConditionUI = useBacktestConfigStore(
    (state) => state.addBuyConditionUI,
  );
  const updateBuyConditionUI = useBacktestConfigStore(
    (state) => state.updateBuyConditionUI,
  );
  const removeBuyConditionUI = useBacktestConfigStore(
    (state) => state.removeBuyConditionUI,
  );
  const setBuyLogic = useBacktestConfigStore((state) => state.setBuyLogic);
  const setPriorityFactor = useBacktestConfigStore(
    (state) => state.setPriorityFactor,
  );
  const setPriorityOrder = useBacktestConfigStore(
    (state) => state.setPriorityOrder,
  );

  const { data: subFactors = [] } = useSubFactorsQuery();
  const { data: factors = [] } = useFactorsQuery();

  // ëª¨ë‹¬ ìƒíƒœ
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [currentConditionId, setCurrentConditionId] = useState<string | null>(
    null,
  );

  // ìš°ì„ ìˆœìœ„ íŒ©í„° ì„ íƒ ëª¨ë‹¬ ìƒíƒœ
  const [isPriorityModalOpen, setIsPriorityModalOpen] = useState(false);
  const [priorityFactorDisplay, setPriorityFactorDisplay] =
    useState<string>("");

  // ë…¼ë¦¬ì‹ ìë™ ìƒì„± ëª¨ë“œ (ê¸°ë³¸ê°’: true)
  const [isAutoLogic, setIsAutoLogic] = useState(true);

  // ì´ˆê¸° ê¸°ë³¸ê°’ ì„¤ì • ì™„ë£Œ ì—¬ë¶€ (race condition ë°©ì§€)
  const initialDefaultSetRef = useRef(false);

  // ìš°ì„ ìˆœìœ„ íŒ©í„° ê¸°ë³¸ê°’ ì„¤ì • (ì»´í¬ë„ŒíŠ¸ ìµœì´ˆ ë§ˆìš´íŠ¸ ì‹œ 1íšŒë§Œ)
  // AI í—¬í¼ì—ì„œ priority_factorë¥¼ ì„¤ì •í•˜ë©´ ì´í›„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë®ì–´ì“°ì§€ ì•ŠìŒ
  useEffect(() => {
    // ì´ë¯¸ ì´ˆê¸° ê¸°ë³¸ê°’ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©´ ë¬´ì‹œ (AI í—¬í¼ ë“± ì™¸ë¶€ì—ì„œ ì„¤ì • ì‹œ ë®ì–´ì“°ê¸° ë°©ì§€)
    if (initialDefaultSetRef.current) return;

    const hasExistingValue = priority_factor && priority_factor.length > 0;

    if (hasExistingValue) {
      // ì´ë¯¸ ê°’ì´ ìˆìœ¼ë©´ ì´ˆê¸°í™” ì™„ë£Œë¡œ í‘œì‹œí•˜ê³  ì¢…ë£Œ
      initialDefaultSetRef.current = true;
      return;
    }

    if (factors.length > 0) {
      // PER íŒ©í„°ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì • (ìµœì´ˆ 1íšŒë§Œ)
      const defaultFactor = factors.find((f) => f.name === "per") || factors[0];
      if (defaultFactor) {
        setPriorityFactor(`ê¸°ë³¸ê°’({${defaultFactor.display_name}})`);
        setPriorityFactorDisplay(`ê¸°ë³¸ê°’({${defaultFactor.display_name}})`);
        initialDefaultSetRef.current = true;
      }
    }
  }, [factors, priority_factor, setPriorityFactor]);

  // ìŠ¤í† ì–´ priority_factor ë³€ê²½ ì‹œ í‘œì‹œ í…ìŠ¤íŠ¸ ë™ê¸°í™”
  useEffect(() => {
    if (priority_factor) {
      const cleaned = priority_factor.replace(/[{}]/g, "");
      setPriorityFactorDisplay(cleaned);
    }
  }, [priority_factor]);

  // ë…¼ë¦¬ ì¡°ê±´ì‹ ìë™ ìƒì„±
  useEffect(() => {
    if (isAutoLogic) {
      if (buyConditionsUI.length > 0) {
        // ì¡°ê±´ IDë“¤ì„ ì¶”ì¶œí•˜ì—¬ "A and B and C" í˜•ì‹ìœ¼ë¡œ ìƒì„±
        const conditionIds = buyConditionsUI.map((c) => c.id);
        const autoGeneratedLogic = conditionIds.join(" and ");
        setBuyLogic(autoGeneratedLogic);
      } else {
        // ì¡°ê±´ì´ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
        setBuyLogic("");
      }
    }
  }, [buyConditionsUI, isAutoLogic, setBuyLogic]);

  // ëª¨ë‹¬ ì—´ê¸°
  const openModal = (id: string) => {
    setCurrentConditionId(id);
    setIsModalOpen(true);
  };

  // ëª¨ë‹¬ ë‹«ê¸°
  const closeModal = () => {
    setIsModalOpen(false);
    setCurrentConditionId(null);
  };

  // íŒ©í„° ì„ íƒ
  const handleFactorSelect = (
    _factorId: string,
    factorName: string,
    subFactorId: string,
    argument?: string,
  ) => {
    if (!currentConditionId) return;

    const subFactor = subFactors.find((sf) => String(sf.id) === subFactorId);
    const subFactorName = subFactor?.display_name || null;

    updateBuyConditionUI(currentConditionId, {
      factorName,
      subFactorName,
      argument,
    });

    closeModal();
  };

  // ì—°ì‚°ì ë³€ê²½
  const handleOperatorChange = (id: string, operator: string) => {
    updateBuyConditionUI(id, { operator });
  };

  // ê°’ ë³€ê²½
  const handleValueChange = (id: string, value: string) => {
    updateBuyConditionUI(id, { value });
  };

  // ì¡°ê±´ì‹ í…ìŠ¤íŠ¸ ìƒì„±
  const getConditionExpression = (condition: any) => {
    if (!condition.factorName) return "íŒ©í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”";

    let text = "";
    if (condition.subFactorName) {
      text = condition.argument
        ? `${condition.subFactorName}({${condition.factorName}},{${condition.argument}})`
        : `${condition.subFactorName}({${condition.factorName}})`;
    } else {
      text = condition.factorName;
    }

    return `${text} ${condition.operator} ${condition.value || "___"}`;
  };

  // í˜„ì¬ ì¡°ê±´ ê°€ì ¸ì˜¤ê¸°
  const getCurrentCondition = () => {
    if (!currentConditionId) return undefined;
    const condition = buyConditionsUI.find((c) => c.id === currentConditionId);
    if (!condition) return undefined;

    return {
      factorName: condition.factorName || undefined,
      subFactorName: condition.subFactorName || undefined,
      argument: condition.argument,
    };
  };

  // ìš°ì„ ìˆœìœ„ íŒ©í„° ì„ íƒ
  const handlePriorityFactorSelect = (
    _factorId: string,
    factorName: string,
    subFactorId: string,
    argument?: string,
  ) => {
    // subFactorIdë¡œ subFactorName ì°¾ê¸°
    const subFactor = subFactors.find((sf) => String(sf.id) === subFactorId);
    const subFactorName = subFactor?.display_name;

    // íŒ©í„° í‘œí˜„ì‹ ìƒì„±
    let expression = "";
    let displayText = "";
    if (subFactorName) {
      if (argument) {
        expression = `${subFactorName}({${factorName}},{${argument}})`;
        displayText = `${subFactorName}({${factorName}},{${argument}})`;
      } else {
        expression = `${subFactorName}({${factorName}})`;
        displayText = `${subFactorName}({${factorName}})`;
      }
    } else {
      expression = `{${factorName}}`;
      displayText = factorName;
    }

    setPriorityFactor(expression);
    setPriorityFactorDisplay(displayText);
    setIsPriorityModalOpen(false);
  };

  return (
    <div id="section-buy-conditions" className="space-y-3">
      <SectionHeader title="ë§¤ìˆ˜ ì¡°ê±´ ì„¤ì •" />

      <FieldPanel conditionType="buy">
        <div className="space-y-10">
          {/* ë§¤ìˆ˜ ì¡°ê±´ì‹ ì„¤ì • */}
          <div>
            <Title variant="subtitle" className="mb-3">
              ë§¤ìˆ˜ ì¡°ê±´ì‹ ì„¤ì •
            </Title>

            {/* ì¡°ê±´ ëª©ë¡ */}
            <div className="space-y-2 mb-2">
              {buyConditionsUI.map((condition) => (
                <ConditionCard
                  key={condition.id}
                  condition={condition}
                  expressionText={getConditionExpression(condition)}
                  onFactorSelect={() => openModal(condition.id)}
                  onOperatorChange={(op) =>
                    handleOperatorChange(condition.id, op)
                  }
                  onValueChange={(val) => handleValueChange(condition.id, val)}
                  onRemove={() => removeBuyConditionUI(condition.id)}
                  conditionType="buy"
                />
              ))}
            </div>

            {/* ì¡°ê±´ ì¶”ê°€ ë²„íŠ¼ */}
            <button
              type="button"
              onClick={addBuyConditionUI}
              className="w-[31.25rem] h-12 flex items-center gap-3 rounded-md border-[0.5px] relative"
            >
              {/* plus ì•„ì´ì½˜ */}
              <div className="">
                <Image
                  src="/icons/plus.svg"
                  alt=""
                  width={48}
                  height={48}
                  className="rounded-tl-md rounded-bl-md"
                />
              </div>

              {/* í…ìŠ¤íŠ¸ */}
              <div className="text-tag-neutral">
                ì¡°ê±´ì‹ì„ ì¶”ê°€í•˜ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”.
              </div>

              {/* ì‚­ì œ ì•„ì´ì½˜ */}
              <Image
                src="/icons/trash.svg"
                alt=""
                width={24}
                height={24}
                className="absolute right-3 opacity-30"
              />
            </button>
          </div>

          {/* ë…¼ë¦¬ ì¡°ê±´ì‹ */}
          <div>
            <div className="flex justify-between items-center w-[31.25rem] mb-3">
              <Title variant="subtitle">ë…¼ë¦¬ ì¡°ê±´ì‹ ì‘ì„±</Title>
              <button
                type="button"
                onClick={() => setIsAutoLogic(!isAutoLogic)}
                className={`px-3 py-1 rounded-md text-sm transition-colors ${isAutoLogic
                  ? "bg-price-up text-white"
                  : "bg-price-up-soft hover:bg-gray-300"
                  }`}
              >
                {isAutoLogic ? "ğŸ¤– ìë™" : "âœï¸ ìˆ˜ë™"}
              </button>
            </div>
            <UnderlineInput
              placeholder="A and B"
              value={buy_logic}
              onChange={(e) => {
                setBuyLogic(e.target.value);
                // ìˆ˜ë™ ì…ë ¥ ì‹œ ìë™ ëª¨ë“œ í•´ì œ
                if (isAutoLogic) {
                  setIsAutoLogic(false);
                }
              }}
              disabled={isAutoLogic}
              className={`w-[31.25rem] ${isAutoLogic ? "bg-gray-50 cursor-not-allowed" : ""
                }`}
            />
            {isAutoLogic && buyConditionsUI.length > 0 && (
              <p className="text-sm text-text-neutral mt-2">
                ğŸ’¡ ì¡°ê±´ì´ ì¶”ê°€/ì‚­ì œë˜ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤
              </p>
            )}
          </div>

          {/* ë§¤ìˆ˜ ì¢…ëª© ì„ íƒ ìš°ì„ ìˆœìœ„ */}
          <div>
            <div className="flex justify-between w-[31.25rem] mb-3">
              <Title variant="subtitle">ë§¤ìˆ˜ ì¢…ëª© ì„ íƒ ìš°ì„ ìˆœìœ„</Title>
              <div className="flex gap-4 justify-center items-center">
                <div className="flex justify-center items-center">
                  <button
                    type="button"
                    onClick={() => setPriorityOrder("desc")}
                    className={`${priority_order === "desc"
                      ? "text-text-strong"
                      : "text-tag-neutral"
                      }`}
                  >
                    ë†’ì€ ê°’ë¶€í„°
                  </button>
                  <Image
                    src="/icons/arrow_down.svg"
                    alt=""
                    width={16}
                    height={16}
                    className={`${priority_order === "desc" ? "opacity-100" : "opacity-30"
                      }`}
                  />
                </div>
                <div className="flex justify-center items-center">
                  <button
                    type="button"
                    onClick={() => setPriorityOrder("asc")}
                    className={`${priority_order === "asc"
                      ? "text-text-strong"
                      : "text-tag-neutral"
                      }`}
                  >
                    ë‚®ì€ ê°’ë¶€í„°
                  </button>
                  <Image
                    src="/icons/arrow_up.svg"
                    alt=""
                    width={16}
                    height={16}
                    className={`${priority_order === "asc" ? "opacity-100" : "opacity-30"
                      }`}
                  />
                </div>
              </div>
            </div>
            <div
              onClick={() => setIsPriorityModalOpen(true)}
              className="w-[31.25rem] p-[14px] border-[0.5px] border-tag-neutral rounded-md cursor-pointer hover:border-accent-primary"
            >
              {priorityFactorDisplay ||
                priority_factor ||
                "íŒ©í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”"}
            </div>
          </div>
        </div>
      </FieldPanel>

      {/* ë§¤ìˆ˜ ì¡°ê±´ì‹ íŒ©í„° ì„ íƒ ëª¨ë‹¬ */}
      <FactorSelectionModal
        isOpen={isModalOpen}
        onClose={closeModal}
        onSelect={handleFactorSelect}
        initialValues={getCurrentCondition() as any}
      />

      {/* ìš°ì„ ìˆœìœ„ íŒ©í„° ì„ íƒ ëª¨ë‹¬ */}
      <FactorSelectionModal
        isOpen={isPriorityModalOpen}
        onClose={() => setIsPriorityModalOpen(false)}
        onSelect={handlePriorityFactorSelect}
      />
    </div>
  );
}
