version: '3.8'
services:
  backend:
    build:
      context: ./SL-Back-end
      dockerfile: Dockerfile
    container_name: sl_backend_prod
    env_file: []
    volumes:
    - ./SL-Back-end:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped
    environment:
    - DATABASE_URL=${DATABASE_URL}
    - DATABASE_SYNC_URL=${DATABASE_SYNC_URL}
    - DATABASE_POOL_SIZE=${DATABASE_POOL_SIZE:-40}
    - DATABASE_MAX_OVERFLOW=${DATABASE_MAX_OVERFLOW:-50}
    - REDIS_URL=${REDIS_URL}
    - REDIS_HOST=${REDIS_HOST}
    - REDIS_PORT=${REDIS_PORT:-6379}
    - REDIS_DB=${REDIS_DB:-0}
    - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    - ENABLE_CACHE=${ENABLE_CACHE:-True}
    - API_V1_PREFIX=${API_V1_PREFIX:-/api/v1}
    - PROJECT_NAME=${PROJECT_NAME:-Quant Investment API}
    - DEBUG=${DEBUG:-False}
    - SECRET_KEY=${SECRET_KEY}
    - BACKEND_CORS_ORIGINS=${BACKEND_CORS_ORIGINS}
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    - DEPLOYMENT_ENV=${DEPLOYMENT_ENV:-ec2}
    - REDIS_SSL=${REDIS_SSL:-False}
    ports:
    - ${BACKEND_PORT:-8000}:8000
    networks:
    - quant_network
  chatbot:
    build:
      context: ./SL-ChatBot
      dockerfile: ./chatbot/Dockerfile
    container_name: sl_chatbot_prod
    env_file:
    - .env
    - ./SL-ChatBot/.env
    environment:
      PYTHONUNBUFFERED: 1
    ports:
    - ${CHATBOT_PORT:-8003}:8003
    volumes:
    - ./SL-ChatBot/chatbot/src:/app/src
    - ./SL-ChatBot/api:/app/api
    - ./SL-ChatBot/config:/app/config
    - ./SL-ChatBot/prompts:/app/prompts
    - ./SL-ChatBot/chatbot/requirements.txt:/app/requirements.txt
    - ./SL-ChatBot/chatbot/config.yaml:/app/config.yaml
    restart: unless-stopped
    networks:
    - quant_network
  frontend:
    build:
      context: ./SL-Front-End
      dockerfile: Dockerfile
      args:
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://54.180.34.167:8000/api/v1}
      - NEXT_PUBLIC_CHATBOT_API_URL=${NEXT_PUBLIC_CHATBOT_API_URL:-http://54.180.34.167:8003}
    container_name: sl_frontend_prod
    environment:
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8000/api/v1}
      NEXT_PUBLIC_CHATBOT_API_URL: ${NEXT_PUBLIC_CHATBOT_API_URL:-http://localhost:8003}
      API_BASE_URL: http://backend:8000/api/v1
    ports:
    - ${FRONTEND_PORT:-3000}:3000
    depends_on:
    - backend
    - chatbot
    restart: unless-stopped
    networks:
    - quant_network
networks:
  quant_network:
    driver: bridge
