# ğŸ”¥ CRITICAL BUG FIX - Factor Calculation (PER/PBR/ROE)

## ë¬¸ì œ ìš”ì•½
**ì‚¼ì„±ì „ìì— PER >= 0 ì¡°ê±´ì„ ì„¤ì •í•˜ê³  ë°±í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í–ˆëŠ”ë° ê±°ë˜ê°€ í•˜ë‚˜ë„ ë°œìƒí•˜ì§€ ì•ŠìŒ**

## ê·¼ë³¸ ì›ì¸ ë¶„ì„

### 1ï¸âƒ£ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜
- **ë¬¸ì œ**: `factor_calculator_complete.py` ì½”ë“œê°€ `financial_statements.report_date` ì»¬ëŸ¼ìœ¼ë¡œ í•„í„°ë§ ì‹œë„
- **ì‹¤ì œ**: ë°ì´í„°ë² ì´ìŠ¤ì— `report_date` ì»¬ëŸ¼ì´ **ì¡´ì¬í•˜ì§€ ì•ŠìŒ**
- **ì˜í–¥**: SQL ì—ëŸ¬ ë°œìƒ â†’ ì¬ë¬´ì œí‘œ ë°ì´í„°ë¥¼ ì „í˜€ ê°€ì ¸ì˜¤ì§€ ëª»í•¨

```python
# ë²„ê·¸ê°€ ìˆë˜ ì½”ë“œ (Line 95-98)
base_filters = [
    FinancialStatement.bsns_year >= start_year,
    FinancialStatement.bsns_year <= end_year,
    FinancialStatement.report_date <= as_of.date()  # âŒ ì´ ì»¬ëŸ¼ì´ DBì— ì—†ìŒ!
]
```

**ê²°ê³¼**:
- ì¬ë¬´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ
- PER, PBR, ROE ê°’ì´ ëª¨ë‘ `None` ë˜ëŠ” `NaN`
- ëª¨ë“  ì¢…ëª©ì´ íŒ©í„° ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ëª»í•¨
- **ê±°ë˜ê°€ í•˜ë‚˜ë„ ë°œìƒí•˜ì§€ ì•ŠìŒ**

### 2ï¸âƒ£ ë°ì´í„° ê²€ì¦
ì‚¼ì„±ì „ì ì‹¤ì œ ë°ì´í„° (2024-01-02 ê¸°ì¤€):
```
Market Cap:    475,194,690,980,000 ì› (475.19ì¡°)
ë‹¹ê¸°ìˆœì´ìµ:     23,582,565,000,000 ì› (23.58ì¡°) - 2024ë…„ ì—°ê°„
ìë³¸ì´ê³„:     236,396,657,000,000 ì› (236.40ì¡°)

ê³„ì‚°ëœ PER = Market Cap / ë‹¹ê¸°ìˆœì´ìµ
         = 475.19ì¡° / 23.58ì¡°
         = 20.15

âœ… PER >= 0 ì¡°ê±´ ë§Œì¡± â†’ ì‚¼ì„±ì „ìëŠ” ë§¤ìˆ˜ ëŒ€ìƒì´ì–´ì•¼ í•¨
âŒ í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” ê±°ë˜ê°€ 0ê±´ ë°œìƒ
```

## í•´ê²° ë°©ë²•

### Fix #1: report_date í•„í„° ì œê±°
```python
# ìˆ˜ì • í›„ (Line 95-97)
base_filters = [
    FinancialStatement.bsns_year >= start_year,
    FinancialStatement.bsns_year <= end_year
    # report_date í•„í„° ì œê±°
]
```

### Fix #2: pandas groupby().apply() ì²˜ë¦¬ ìˆ˜ì •
```python
# ë²„ê·¸: rename()ì´ scalar ê°’ì—ì„œ ì‹¤íŒ¨
turnover = recent_window.groupby('stock_code').apply(...).rename('TURNOVER_RATE')

# ìˆ˜ì •: Seriesì˜ name ì†ì„± ì§ì ‘ ì„¤ì • ë° index merge ì‚¬ìš©
turnover_series = recent_window.groupby('stock_code').apply(
    lambda g: ...,
    include_groups=False
)
turnover_series.name = 'TURNOVER_RATE'

# merge ì‹œ index ì‚¬ìš©
merged = merged.merge(turnover_series, left_on='stock_code', right_index=True, how='left')
```

## í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ìˆ˜ì • ì „
```
âŒ ì¬ë¬´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨
âŒ PER = None
âŒ ì‚¼ì„±ì „ì PER >= 0 ì¡°ê±´: ì‹¤íŒ¨
âŒ ê±°ë˜ ë°œìƒ: 0ê±´
```

### ìˆ˜ì • í›„
```
âœ… ì¬ë¬´ ë°ì´í„° ë¡œë“œ ì„±ê³µ
âœ… PER = 20.1503
âœ… ì‚¼ì„±ì „ì PER >= 0 ì¡°ê±´: True
âœ… ì´ì œ ì •ìƒì ìœ¼ë¡œ ë§¤ìˆ˜ ê°€ëŠ¥
```

## ì˜í–¥ ë²”ìœ„

ì´ ë²„ê·¸ëŠ” **ëª¨ë“  íŒ©í„° ê¸°ë°˜ ë°±í…ŒìŠ¤íŠ¸**ì— ì˜í–¥ì„ ë¯¸ì³¤ìŠµë‹ˆë‹¤:
- PER (ì£¼ê°€ìˆ˜ìµë¹„ìœ¨)
- PBR (ì£¼ê°€ìˆœìì‚°ë¹„ìœ¨)
- ROE (ìê¸°ìë³¸ì´ìµë¥ )
- ROA (ì´ìì‚°ì´ìµë¥ )
- DEBT_RATIO (ë¶€ì±„ë¹„ìœ¨)

ëª¨ë“  íŒ©í„° ê°’ì´ None/NaNì´ì—ˆê¸° ë•Œë¬¸ì— íŒ©í„° ì¡°ê±´ì„ ì‚¬ìš©í•œ ëª¨ë“  ë°±í…ŒìŠ¤íŠ¸ê°€ **ê±°ë˜ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤**.

## ìˆ˜ì • íŒŒì¼

- `SL-Back-end/app/services/factor_calculator_complete.py`
  - Line 95-97: report_date í•„í„° ì œê±°
  - Line 224-228: turnover ê³„ì‚° ìˆ˜ì •
  - Line 231-236: momentum ê³„ì‚° ìˆ˜ì •
  - Line 247-250: merge ë°©ì‹ ìˆ˜ì • (left_on + right_index)

## ë‹¤ìŒ ë‹¨ê³„

1. âœ… íŒ©í„° ê³„ì‚° ìˆ˜ì • ì™„ë£Œ
2. â³ ìƒˆë¡œìš´ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰í•˜ì—¬ ê±°ë˜ ë°œìƒ í™•ì¸
3. â³ BUY tradesê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ëŠ”ì§€ í™•ì¸
4. â³ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê±°ë˜ ë‚´ì—­ ì •ìƒ í‘œì‹œ í™•ì¸

## ê´€ë ¨ ì´ìŠˆ

ì´ ìˆ˜ì •ìœ¼ë¡œ í•´ê²°ë˜ëŠ” ë¬¸ì œë“¤:
- ì‚¼ì„±ì „ì PER >= 0 ì¡°ê±´ì—ì„œ ê±°ë˜ ì—†ìŒ
- "factor_value is None or NaN" ë¡œê·¸ ë©”ì‹œì§€
- ëª¨ë“  íŒ©í„° ê¸°ë°˜ ë°±í…ŒìŠ¤íŠ¸ì—ì„œ ë§¤ìˆ˜ í›„ë³´ 0ê°œ

---
**ìˆ˜ì • ë‚ ì§œ**: 2025-11-11
**ìˆ˜ì •ì**: Claude Code
**ì‹¬ê°ë„**: CRITICAL ğŸ”¥
