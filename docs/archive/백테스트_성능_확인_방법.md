# 백테스트 성능 확인 방법

## 🔍 로그에서 확인하는 방법

### 1. 실시간으로 로그 모니터링

터미널에서 다음 명령어를 실행하세요:

```bash
docker logs -f sl_backend_dev | grep -E "(극한|초고속|슈퍼|최적화|팩터 계산|완료|시간)"
```

### 2. 백테스트 시작 후 확인할 로그

백테스트를 실행하면 다음과 같은 로그가 나타납니다:

#### ✅ 최적화 모드 활성화 확인
```
✅ 백테스트 최적화 모듈 적용 완료!
🔥 극한 최적화 엔진 초기화: 10개 워커 (모든 CPU 코어)
```

#### ✅ 데이터 로드 최적화 확인
```
🚀 최적화된 가격 데이터 로드 사용
🚀 최적화된 재무 데이터 로드 사용
```

#### ✅ 팩터 계산 모드 확인 (가장 중요!)

**극한 최적화 모드가 활성화된 경우:**
```
🔥🔥🔥 극한 최적화 모드 활성화 (Extreme Performance)
🔥 JIT 함수 워밍업 시작...
✅ JIT 워밍업 완료: X.XX초
🔥 극한 최적화 계산 시작 (XXX개 × XX일)
✅ 극한 최적화 완료: XXX개 종목
```

**초고속 모드가 활성화된 경우:**
```
⚡⚡⚡ 초고속 모드 활성화 (Numba JIT + 병렬 처리)
🚀 Numba JIT 병렬 계산 시작 (XXX개 종목 × XX일)
✅ Numba JIT 계산 완료: XXX개 종목
```

**슈퍼 최적화 (통합 모드):**
```
🚀🚀🚀 슈퍼 최적화된 팩터 계산 시작
⚡ 벡터화 계산 완료: XX.XX초 (XXX개 날짜)
✅ 슈퍼 최적화 팩터 계산 완료: XX.XX초 (기존 대비 XX.X배 빠름!)
```

#### ✅ 성능 측정 (핵심!)

**이 로그에서 실제 시간을 확인하세요:**
```
✅ 슈퍼 최적화 팩터 계산 완료: 7.48초 (기존 대비 66.8배 빠름!)
                                 ^^^^
                              여기가 실제 시간!
```

### 3. 백테스트 전체 시간 확인

백테스트 시작과 완료 로그의 타임스탬프를 비교하세요:

```
2025-11-14 11:10:58 - 백테스트 시작
2025-11-14 11:12:21 - 백테스트 완료
```

위 예시에서는: **11:12:21 - 11:10:58 = 약 1분 23초**

---

## 📊 주요 성능 지표

### 1. 팩터 계산 시간 (가장 중요!)

**기존 (최적화 전):**
- 모멘텀 팩터: 126초
- 기술적 지표: 126초
- 기타 팩터: 25초
- **합계: 약 350-500초 (5-8분)**

**최적화 후:**
- **전체 팩터 계산: 7-10초** ⚡
- **개선율: 50-70배 빠름!**

### 2. 전체 백테스트 시간

**기존:**
- 팩터 계산: 350-500초
- DB 읽기/쓰기: 80-100초
- 시뮬레이션: 50초
- **합계: 8-10분 (480-600초)**

**최적화 후:**
- 팩터 계산: 7-10초
- DB 읽기/쓰기: 5-10초
- 시뮬레이션: 10-15초
- **합계: 20-40초** ⚡
- **개선율: 15-30배 빠름!**

---

## 🐛 매수/매도가 0개인 문제 해결

### 원인 1: 극한 최적화 모드 오류

**증상:**
```
극한 최적화 실패: DataFrame.sort() missing 1 required positional argument: 'by'
💰 매수 후보(전체): 0개
```

**해결:** ✅ 이미 수정 완료! (Polars sort 문법 수정)

### 원인 2: 조건에 맞는 종목이 없음

**확인 방법:**
로그에서 다음을 확인하세요:

```
🎯 가치 팩터 계산 시작 - required_factors: {'ROE', 'PBR'}
🎯 latest_price 건수: XXX, latest_financial 건수: XXX
```

만약 `latest_financial 건수: 0`이면 재무 데이터가 없는 것입니다.

**해결 방법:**
- 더 완화된 조건 사용 (예: ROE > 10, PBR < 3)
- 다른 테마 선택 (예: IT 서비스 → 전체 종목)

### 원인 3: 팩터 계산 실패

**확인 방법:**
```bash
docker logs sl_backend_dev 2>&1 | grep -E "(팩터.*계산|ERROR|WARN)" | tail -n 30
```

**오류가 있다면:** 로그를 복사해서 확인해드릴게요.

---

## ✅ 정상 작동 확인 체크리스트

백테스트가 정상적으로 작동하는지 확인하세요:

### 1. 최적화 모듈 로드
```
✅ 백테스트 최적화 모듈 적용 완료!
```

### 2. 최적화 모드 활성화
```
🔥🔥🔥 극한 최적화 모드 활성화
또는
⚡⚡⚡ 초고속 모드 활성화
또는
🚀🚀🚀 슈퍼 최적화된 팩터 계산 시작
```

### 3. 팩터 계산 완료
```
✅ 극한 최적화 완료: XXX개 종목
또는
✅ 슈퍼 최적화 팩터 계산 완료: X.XX초
```

### 4. 매수 후보 확인
```
💰 매수 후보(전체): XX개 - [종목들...]
```
- **0개가 아니어야 정상!**

### 5. 거래 발생 확인
```
✅ 매수 체결: 종목명(XXX) | 가격: XX,XXX원 | 수량: XXX주
```

### 6. 백테스트 완료
```
백테스트 완료 - Session: xxx-xxx-xxx
```

---

## 📈 예상 성능 (정상 작동 시)

### IT 서비스 테마, 1년 백테스트 기준

| 단계 | 예상 시간 |
|------|----------|
| 가격 데이터 로드 | 1-2초 |
| 재무 데이터 로드 | 2-3초 |
| **팩터 계산** | **7-10초** ⚡ |
| 시뮬레이션 (244일) | 10-15초 |
| DB 저장 | 1-2초 |
| **전체** | **20-35초** ⚡ |

### 전체 종목, 1년 백테스트 기준

| 단계 | 예상 시간 |
|------|----------|
| 가격 데이터 로드 | 3-5초 |
| 재무 데이터 로드 | 5-8초 |
| **팩터 계산** | **15-25초** ⚡ |
| 시뮬레이션 (244일) | 20-30초 |
| DB 저장 | 2-3초 |
| **전체** | **45-75초** ⚡ |

---

## 🔧 빠른 테스트 명령어

### 1. 로그 실시간 모니터링 (추천!)

```bash
# 최적화 관련 로그만 보기
docker logs -f sl_backend_dev | grep -E "(극한|초고속|슈퍼|최적화|팩터 계산)"

# 매수/매도 로그만 보기
docker logs -f sl_backend_dev | grep -E "(매수|매도|후보)"

# 전체 백테스트 진행 상황
docker logs -f sl_backend_dev | grep -E "(진행|완료|시간)"
```

### 2. 최근 백테스트 성능 확인

```bash
# 최근 백테스트의 팩터 계산 시간 확인
docker logs sl_backend_dev 2>&1 | grep "슈퍼 최적화 팩터 계산 완료" | tail -n 5

# 최근 백테스트의 전체 시간 확인 (타임스탬프 비교)
docker logs sl_backend_dev 2>&1 | grep -E "(백테스트 시작|백테스트 완료)" | tail -n 10
```

### 3. 에러 확인

```bash
# 최근 에러 로그 확인
docker logs sl_backend_dev 2>&1 | grep -E "(ERROR|극한 최적화 실패)" | tail -n 20
```

---

## 💡 성능 개선이 보이지 않는다면?

### 체크리스트:

1. **Redis가 실행 중인가?**
   ```bash
   docker ps | grep redis
   ```
   - Running 상태여야 함

2. **Numba가 설치되었는가?**
   ```bash
   docker exec sl_backend_dev pip list | grep numba
   ```
   - `numba 0.60.0` 이 보여야 함

3. **최적화 모듈이 로드되었는가?**
   ```bash
   docker logs sl_backend_dev 2>&1 | grep "백테스트 최적화 모듈 적용"
   ```
   - "✅ 적용 완료!" 가 보여야 함

4. **캐시가 작동하는가?**
   ```bash
   docker logs sl_backend_dev 2>&1 | grep "캐시 히트"
   ```
   - 두 번째 실행부터는 캐시 히트율이 높아야 함

---

## 📞 문제 발생 시

다음 명령어로 전체 로그를 확인하고 알려주세요:

```bash
docker logs sl_backend_dev 2>&1 | tail -n 300 > backtest_logs.txt
```

로그에서 확인할 내용:
- ❌ ERROR 메시지
- ⚠️ 극한 최적화 실패
- 💰 매수 후보 0개
- 📊 팩터 계산 시간

이 정보를 공유해주시면 문제를 정확히 파악할 수 있습니다!
